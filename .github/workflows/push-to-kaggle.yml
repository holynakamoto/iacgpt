name: Push to Kaggle

on:
  push:
    branches:
      - master
    paths:
      - 'kaggle_iacgpt_training.ipynb'
      - 'claude.yml'
      - '.github/workflows/push-to-kaggle.yml'
  workflow_dispatch:

jobs:
  push-notebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Setup Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync

      - name: Setup Kaggle credentials
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Push notebook and start execution on Kaggle
        run: |
          uv run python scripts/kaggle_runner.py --timeout-hours 4
          echo "âœ… Training started on Kaggle GPU P100!"
          echo "ðŸ”— View at: https://www.kaggle.com/code/nicksmoore/iacgpt-v2"

      - name: Summary
        run: |
          echo "## ðŸš€ Training Started on Kaggle GPU P100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your IaC-GPT training is now running on Kaggle with GPU acceleration." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Notebook pushed via API" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Execution started automatically" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ Timeout: 4 hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor:**" >> $GITHUB_STEP_SUMMARY
          echo "- [View kernel on Kaggle](https://www.kaggle.com/code/nicksmoore/iacgpt-v2)" >> $GITHUB_STEP_SUMMARY
          echo "- Or run: \`kaggle kernels output nicksmoore/iacgpt-v2\`" >> $GITHUB_STEP_SUMMARY
